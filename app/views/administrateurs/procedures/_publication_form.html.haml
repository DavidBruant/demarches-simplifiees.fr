= form_tag admin_procedure_publish_path(procedure_id: procedure.id), method: :put, class: 'form' do
  = render Procedure::PublicationWarningComponent.new(procedure: procedure)
  .mt-2
    - if procedure.draft_changed?
      %p.mb-2 Publiez une nouvelle version de votre démarche. Les modifications suivantes seront appliquées :
      = render Dsfr::AlertComponent.new(state: :info, size: :sm, extra_class_names: 'fr-mb-2w') do |c|
        - c.body do
          = render Procedure::RevisionChangesComponent.new changes: procedure.revision_changes, previous_revision: procedure.published_revision
      - if procedure.close?
        = render partial: 'publication_form_inputs', locals: { procedure: procedure, closed_procedures: @closed_procedures }
    - elsif @procedure.brouillon? && @procedure.missing_steps.empty?
      = render partial: 'publication_form_inputs', locals: { procedure: procedure, closed_procedures: @closed_procedures }
      = render Dsfr::CalloutComponent.new(title: "Avant de publier", heading_level: 'h2') do |c|
        - c.with_body do
          %p.fr-mb-2w
            Avez-vous bien pensé à informer votre Délégué à la Protection des Données personnelles (DPD).
            %a{ href:'https://www.cnil.fr/fr/protection-des-donnees-les-bons-reflexes', target:'_blank' }
              https://www.cnil.fr/fr/protection-des-donnees-les-bons-reflexes

          %p.fr-mb-2w
            Si votre démarche propose de collecter des données personnelles, vous devez informer votre DPD. Chaque organisme en a un.

          %p.fr-mb-2w
            Ce dernier pourra vous aider dans la finalisation de votre démarche, et vous inviter à vous interroger sur les données collectées, et sur la pertinence de ces dernières.
            N'oubliez pas : toutes les démarches qui contiennent des données personnelles doivent être consignées dans un registre des traitements :
            %a{ href:'https://www.cnil.fr/fr/RGDP-le-registre-des-activites-de-traitement', target:'_blank' }
              https://www.cnil.fr/fr/RGDP-le-registre-des-activites-de-traitement

          %p.fr-mb-2w
            Comment faire ?
            Vous pouvez soit lui communiquer par email le lien vers la démarche en test, ou bien le nommer « administrateur ». Dans tous les cas, ne publiez votre démarche qu’après avoir eu son avis.

    - else
      = render partial: 'publication_form_inputs', locals: { procedure: procedure, closed_procedures: @closed_procedures }

  .flex.fr-mb-5w
    = submit_tag procedure_publish_label(procedure, :submit), { disabled: procedure.errors.present?, class: "fr-btn fr-btn--primary", id: 'publish' }
    = link_to 'Annuler et revenir à la page de la démarche', admin_procedure_path(id: @procedure), class: 'fr-btn fr-btn--secondary fr-btn--icon-left fr-icon-arrow-go-back-line fr-ml-1w'
